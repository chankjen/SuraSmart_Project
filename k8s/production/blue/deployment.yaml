# k8s/production/deployment.yaml
"""
Kubernetes Deployment Configuration
TRD Section 7.3: Blue-green deployment strategy
TRD Section 6.1.2: 99.95% availability
"""

apiVersion: apps/v1
kind: Deployment
metadata:
  name: sura-smart-green
  namespace: sura-smart
  labels:
    app: sura-smart
    version: green
    trd-compliance: "7.3"
spec:
  replicas: 3  # TRD 6.1.3: Support 10,000 concurrent users
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0  # Zero downtime (TRD 6.1.2)
  selector:
    matchLabels:
      app: sura-smart
      version: green
  template:
    metadata:
      labels:
        app: sura-smart
        version: green
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
    spec:
      containers:
      - name: sura-smart-app
        image: ghcr.io/sura-smart/sura-smart:latest
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: sura-smart-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: sura-smart-secrets
              key: redis-url
        - name: BLOCKCHAIN_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: sura-smart-secrets
              key: blockchain-endpoint
        - name: MODEL_ACCURACY_THRESHOLD
          value: "0.98"  # TRD 6.2.1
        - name: SEARCH_TIME_SLA
          value: "30"    # TRD 6.1.1
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /api/v1/health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 3  # TRD 6.1.2: High availability
        readinessProbe:
          httpGet:
            path: /api/v1/health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
          failureThreshold: 3
        volumeMounts:
        - name: model-storage
          mountPath: /app/models
      - name: edge-ai-sidecar
        image: ghcr.io/sura-smart/sura-smart-edge:latest
        ports:
        - containerPort: 8001
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
      volumes:
      - name: model-storage
        persistentVolumeClaim:
          claimName: sura-smart-model-pvc
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: sura-smart
              topologyKey: kubernetes.io/hostname
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: sura-smart-hpa
  namespace: sura-smart
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: sura-smart-green
  minReplicas: 3   # TRD 6.1.3: Minimum for high availability
  maxReplicas: 20  # TRD 9.1: Horizontal scaling
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 4
        periodSeconds: 15
      selectPolicy: Max